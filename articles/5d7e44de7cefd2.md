---
title: "データベースのアクセスする部分のテストはモックは使わずコンテナを使う"
emoji: "🐰"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["golang"]
published: false
---

# はじめに
クリーンアーキテクチャの主な目的の一つに、「ビジネスロジックを独立してテストできる」というものがあります。

# 背景
プロジェクト内にて、テストを充実させることの機運が高まったこともあり、dbをmockにしてテストを書いていた。
工数はかかったが、これでバグが減るのであればと思い、それぞれの処理にテストを追加していった。


```go

```

# バグはあまり減らなかった
CI/CDテストは合格、安心して環境にデプロイした。
で結果バグが減ったかと思いきや、バグが起きた。
モックテストでは検出できないバグは多くある。

#### テーブル名とcolumnの文字列が一致していない
これにより、構造体のフィールドに値が入らず、ゼロ値で処理が進んでしまう。
データを実際に入れないと気づけない。

#### primaryKeyをつけ忘れる
Updateの処理にて500エラーになる。モックにしているとこのエラーは気づけない。

#### where句内の文字列の間違い
フロントから「一覧取得でクエリによる絞り込みができない」とQAから報告があるまで気づきにくい。

#### filterパターンのミス
if文でクエリを構築しているところのチェックが漏れてしまいがち。

#### テストを書いたという安心感
これほど確認できていないことがあるにも関わらず、テストを書いたことで安心してしまい、エンドポイントをたたいてテストすることを横着するようになっていた。「テストコードを書く」という工数がかかったこともあり、

結果、テストを書くモチベーションが減り、あまり書かなくなってしまう。そうなるとまた違う問題が起きる

#### リファクタリングでエラーになる。
修正に弱くなってしまう。

#### 期待値がわかりにくい
テストそのものがドキュメントの役割もある。

# モックで担保できることは
if文の条件分岐はきちんとできるのかもしれない。
for文もチェックできるかもしれない。

# 改善策: repository層をコンテナを使ってテストする
- testcontainers、dockertest
メリットは大きい。

# usecase、service層のテストではモックを使い、ビジネスロジックにだけ注力する
repository層以下が担保されていることで、安心してビジネスロジックのテストができる。

# 終わりに
mockでテストをして、工数がかかるもののリターンが少ない。